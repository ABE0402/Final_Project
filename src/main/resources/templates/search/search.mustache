<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HonG Around</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
</head>
<body>
{{> layout/header}}


<main class="bg-body-tertiary py-5">
    <div class="container text-center">
        <h1 class="display-3 fw-bold brand-title">HonG Around</h1>

        <form action="/search" method="get" class="mx-auto mt-4" style="max-width: 640px;">
            <input type="hidden" id="search-category" name="category" value="all">
            <input type="hidden" id="search-companion" name="companion">
            <input type="hidden" id="search-mood" name="mood">
            <input type="hidden" id="search-amenities" name="amenities">
            <input type="hidden" id="search-reservation" name="reservation">
            <input type="hidden" id="search-days" name="days">
            <input type="hidden" id="search-sort" name="sort" value="hits">
            <input type="hidden" id="search-type" name="type">

            <div class="input-group input-group-lg shadow-sm">
                <div class="btn-group">
                    <button type="button" id="category-dropdown-button" class="btn btn-outline-secondary dropdown-toggle"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        전체
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item main-category-item" href="#" data-value="all">전체</a></li>
                        <li><a class="dropdown-item main-category-item" href="#" data-value="restaurant">🍽️ 식당</a></li>
                        <li><a class="dropdown-item main-category-item" href="#" data-value="cafe">☕ 카페</a></li>
                    </ul>
                </div>

                <input type="search" name="query" class="form-control" placeholder="가게 이름, 메뉴, 지역 검색" aria-label="Search">

                <button class="btn btn-info text-white" type="button" id="cafe-filter-trigger" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#filterModal">
                    카페 필터
                </button>
                <button class="btn btn-warning text-dark" type="button" id="restaurant-filter-trigger" style="display: none;"
                        data-bs-toggle="modal" data-bs-target="#filterModal">
                    식당 필터
                </button>

                <button class="btn btn-primary" type="submit">🔍</button>
            </div>
        </form>

    </div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">☕ 카페 상세 필터</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="filter-group mb-4">
                    <h6>동반인 <small class="text-muted">(다중 선택 가능)</small></h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-companion">
                        <button type="button" class="btn btn-outline-secondary" data-value="solo">👤 1인</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="friends">🎉 친구</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="couple">💖 커플</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="family">👨‍👩‍👧‍👦 가족</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="group">🏢 단체</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>분위기 <small class="text-muted">(다중 선택 가능)</small></h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-mood">
                        <button type="button" class="btn btn-outline-secondary" data-value="quiet">🤫 조용한</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="talk">💬 대화하기 좋은</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="study">📚 카공하기 좋은</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="photo-spot">📸 사진 맛집</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>편의 및 서비스 <small class="text-muted">(다중 선택 가능)</small></h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-amenities">
                        <button type="button" class="btn btn-outline-secondary" data-value="parking">🚗 주차장</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="pet-friendly">🐾 반려동물</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="takeout">🥡 포장</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>영업 요일 <small class="text-muted">(다중 선택 가능)</small></h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-days">
                        <button type="button" class="btn btn-outline-secondary" data-value="mon">월</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="tue">화</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="wed">수</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="thu">목</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="fri">금</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="sat">토</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="sun">일</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>종류 <small class="text-muted">(다중 선택 가능)</small></h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-type">
                        <button type="button" class="btn btn-outline-secondary" data-value="dessert">🍰 디저트 전문</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="coffee">☕ 커피 전문</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="interior">🛋️ 인테리어 맛집</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>예약 여부</h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-reservation">
                        <button type="button" class="btn btn-outline-secondary" data-value="any">상관없음</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="possible">✅ 가능</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="impossible">❌ 불가능</button>
                    </div>
                </div>

                <div class="filter-group mb-4">
                    <h6>우선순위 (정렬)</h6>
                    <div class="btn-group flex-wrap gap-2" role="group" id="filter-sort">
                        <button type="button" class="btn btn-secondary" data-value="hits">⭐ 많이 찾는 순</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="reviews">📝 리뷰 많은 순</button>
                        <button type="button" class="btn btn-outline-secondary" data-value="rating">👍 평점 높은 순</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="reset-filters">초기화</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="apply-filters">필터 적용</button>
            </div>
        </div>
    </div>
</div>


    <div class="container mt-5">
        <hr class="my-4">
        <section class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">추천 스팟</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-secondary active">전체</button>
                    <button class="btn btn-outline-secondary">평점순</button>
                    <button class="btn btn-outline-secondary">리뷰순</button>
                </div>
            </div>


            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
                {{#cards}}
                    <div class="col">
                        <a class="card h-100 text-decoration-none text-reset" href="/{{type == 'CAFE' ? 'cafes' : 'restaurants'}}/{{id}}">
                            <div class="ratio ratio-16x9 bg-light card-img-top" style="background-image:url('{{heroImageUrl}}'); background-size:cover; background-position:center"></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-title text-truncate">{{name}}</h6>
                                    <span class="badge text-bg-success">{{type}}</span>
                                </div>
                                <div class="small text-muted text-truncate">{{address}}</div>
                                <div class="mt-2 small">⭐ {{averageRating}} · 리뷰 {{reviewCount}}</div>
                            </div>
                        </a>
                    </div>
                {{/cards}}
                {{^cards}}
                    <div class="col"><div class="alert alert-light border">아직 데이터가 없어요. 가게를 등록해 보세요!</div></div>
                {{/cards}}
            </div>
        </section>
    </div>
</main>


{{> layout/footer}}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html><script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM 요소 선택 ---
        const mainCategoryButton = document.getElementById('category-dropdown-button');
        const mainCategoryInput = document.getElementById('search-category');
        const mainDropdownItems = document.querySelectorAll('.main-category-item');
        const cafeFilterTrigger = document.getElementById('cafe-filter-trigger');
        const restaurantFilterTrigger = document.getElementById('restaurant-filter-trigger');
        const modalTitle = document.getElementById('filterModalLabel');
        const modalBody = document.querySelector('#filterModal .modal-body');

        // ✅ 1. '카페'와 '식당' 필터 데이터를 별도 객체로 정의
        const filterData = {
            cafe: {
                title: '☕ 카페 상세 필터',
                groups: [
                    { id: 'companion', title: '동반인', multi: true, options: [
                        { value: 'solo', text: '👤 1인' }, { value: 'friends', text: '🎉 친구' }, { value: 'couple', text: '💖 커플' }, { value: 'family', text: '👨‍👩‍👧‍👦 가족' }, { value: 'group', text: '🏢 단체' }
                    ]},
                    { id: 'mood', title: '분위기', multi: true, options: [
                        { value: 'quiet', text: '🤫 조용한' }, { value: 'talk', text: '💬 대화하기 좋은' }, { value: 'study', text: '📚 카공하기 좋은' }, { value: 'feel good', text: '🍷 분위기 좋은' }, { value: 'date', text: '💖 데이트하기 좋은' }, { value: 'photo-spot', text: '📸 사진 맛집' }
                    ]},
                    { id: 'amenities', title: '편의 및 서비스', multi: true, options: [
                        { value: 'parking', text: '🚗 주차장' }, { value: 'toilet', text: '🚻 화장실' }, { value: 'pet-friendly', text: '🐾 반려동물' }, { value: 'waiting room', text: '🛌 대기실' }, { value: 'takeout', text: '🥡 포장' }
                    ]},
                    { id: 'days', title: '영업 요일', multi: true, options: [
                        { value: 'mon', text: '월' }, { value: 'tue', text: '화' }, { value: 'wed', text: '수' }, { value: 'thu', text: '목' }, { value: 'fri', text: '금' }, { value: 'sat', text: '토' }, { value: 'sun', text: '일' }
                    ]},
                    { id: 'type', title: '종류', multi: true, options: [
                        { value: 'dessert', text: '🍰 디저트 전문' }, { value: 'coffee', text: '☕ 커피 전문' }, { value: 'interior', text: '🛋️ 인테리어 맛집' }, { value: 'photo-spot', text: '📸 사진 맛집' }
                    ]},
                    { id: 'reservation', title: '예약 여부', multi: false, default: 'any', options: [
                        { value: 'any', text: '상관없음' }, { value: 'possible', text: '✅ 가능' }, { value: 'impossible', text: '❌ 불가능' }
                    ]},
                    { id: 'sort', title: '우선순위 (정렬)', multi: false, default: 'hits', options: [
                        { value: 'hits', text: '⭐ 많이 찾는 순' }, { value: 'reviews', text: '📝 리뷰 많은 순' }, { value: 'rating', text: '👍 평점 높은 순' }, { value: 'like', text: '⭐️ 즐겨찾기 많은 순' }
                    ]},
                ]
            },
            restaurant: {
                title: '🍽️ 식당 상세 필터',
                groups: [
                    { id: 'companion', title: '동반인', multi: true, options: [
                        { value: 'solo', text: '👤 1인' }, { value: 'friends', text: '🎉 친구' }, { value: 'couple', text: '💖 커플' }, { value: 'family', text: '👨‍👩‍👧‍👦 가족' }, { value: 'group', text: '🏢 단체' }
                    ]},
                     { id: 'mood', title: '분위기', multi: true, options: [
                        { value: 'quiet', text: '🤫 조용한' }, { value: 'solo-friendly', text: '🍚 혼밥하기 좋은' }, { value: 'date', text: '💖 데이트하기 좋은' },  { value: 'feel good', text: '🍷 분위기 좋은' }, { value: 'photo-spot', text: '📸 사진 맛집' }
                    ]},
                    { id: 'amenities', title: '편의시설', multi: true, options: [
                        { value: 'parking', text: '🚗 주차장' }, { value: 'toilet', text: '🚻 화장실' }, { value: 'pet-friendly', text: '🐾 반려동물' }, { value: 'waiting room', text: '🛌 대기실' }, { value: 'takeout', text: '🥡 포장' }
                    ]},
                    { id: 'days', title: '영업 요일', multi: true, options: [
                        { value: 'mon', text: '월' }, { value: 'tue', text: '화' }, { value: 'wed', text: '수' }, { value: 'thu', text: '목' }, { value: 'fri', text: '금' }, { value: 'sat', text: '토' }, { value: 'sun', text: '일' }
                    ]},
                    { id: 'type', title: '종류', multi: true, options: [
                        { value: 'korean', text: '🍚 한식' }, { value: 'chinese', text: '🍜 중식' }, { value: 'japanese', text: '🍣 일식' }, { value: 'western', text: '🍝 양식' }, { value: 'fusion', text: '🥘 퓨전' }, { value: 'asian', text: '🥠 아시안' }
                    ]},
                    { id: 'reservation', title: '예약 여부', multi: false, default: 'any', options: [
                        { value: 'any', text: '상관없음' }, { value: 'possible', text: '✅ 가능' }, { value: 'impossible', text: '❌ 불가능' }
                    ]},
                     { id: 'sort', title: '우선순위 (정렬)', multi: false, default: 'hits', options: [
                        { value: 'hits', text: '⭐ 많이 찾는 순' }, { value: 'reviews', text: '📝 리뷰 많은 순' }, { value: 'rating', text: '👍 평점 높은 순' }, { value: 'like', text: '⭐️ 즐겨찾기 많은 순' }
                    ]},
                ]
            }
        };

        // --- 필터 상태 관리 ---
        let activeFilterCategory = null;
        let selectedFilters = {};

        // ✅ 2. 모달 내용을 동적으로 생성하는 함수
        function buildModalBody(category) {
            activeFilterCategory = category;
            const data = filterData[category];
            modalTitle.innerHTML = data.title;
            modalBody.innerHTML = ''; // 기존 내용 비우기

            data.groups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'filter-group mb-4';

                const multiText = group.multi ? '<small class="text-muted">(다중 선택 가능)</small>' : '';
                groupDiv.innerHTML = `<h6>${group.title} ${multiText}</h6>`;

                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group flex-wrap gap-2';
                btnGroup.id = `filter-${group.id}`;

                group.options.forEach(opt => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-outline-secondary';
                    button.dataset.value = opt.value;
                    button.innerHTML = opt.text;
                    btnGroup.appendChild(button);
                });
                groupDiv.appendChild(btnGroup);
                modalBody.appendChild(groupDiv);
            });
            initializeFilters(); // 필터 상태 초기화 및 UI 반영
        }

        // --- 이벤트 리스너 ---

        // 3. 메인 카테고리 선택
        mainDropdownItems.forEach(item => {
            item.addEventListener('click', function (event) {
                event.preventDefault();
                const selectedValue = this.getAttribute('data-value');
                mainCategoryButton.innerHTML = this.innerHTML;
                mainCategoryInput.value = selectedValue;

                cafeFilterTrigger.style.display = (selectedValue === 'cafe') ? 'block' : 'none';
                restaurantFilterTrigger.style.display = (selectedValue === 'restaurant') ? 'block' : 'none';
            });
        });

        // 4. 필터 버튼 클릭 시 해당 카테고리에 맞는 모달 내용 생성
        [cafeFilterTrigger, restaurantFilterTrigger].forEach(trigger => {
            trigger.addEventListener('click', function() {
                const category = this.id.includes('cafe') ? 'cafe' : 'restaurant';
                buildModalBody(category);
            });
        });

        // 5. 모달 내부 클릭 이벤트 (이벤트 위임)
        modalBody.addEventListener('click', function(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const groupDiv = button.closest('.filter-group');
            const groupId = groupDiv.querySelector('.btn-group').id.replace('filter-', '');
            const value = button.dataset.value;
            const isMulti = filterData[activeFilterCategory].groups.find(g => g.id === groupId).multi;

            if (isMulti) {
                button.classList.toggle('active');
                if (selectedFilters[groupId].has(value)) {
                    selectedFilters[groupId].delete(value);
                } else {
                    selectedFilters[groupId].add(value);
                }
            } else {
                groupDiv.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                selectedFilters[groupId] = value;
            }
        });

        // 필터 상태를 초기화하는 함수
        function initializeFilters() {
            const data = filterData[activeFilterCategory];
            selectedFilters = {}; // 초기화
            data.groups.forEach(group => {
                if (group.multi) {
                    selectedFilters[group.id] = new Set();
                } else {
                    selectedFilters[group.id] = group.default;
                    // UI에 기본값 활성화 표시
                    const defaultBtn = modalBody.querySelector(`#filter-${group.id} button[data-value="${group.default}"]`);
                    if (defaultBtn) defaultBtn.classList.add('active');
                }
            });
        }

        // '필터 적용' 버튼
        document.getElementById('apply-filters').addEventListener('click', function() {
            for (const key in selectedFilters) {
                const input = document.getElementById(`search-${key}`);
                if (input) {
                    const value = selectedFilters[key];
                    input.value = (value instanceof Set) ? [...value].join(',') : value;
                }
            }
        });

        // '초기화' 버튼
        document.getElementById('reset-filters').addEventListener('click', initializeFilters);
    });
</script>